pipeline {
    agent any
    environment {
        RIOT_API_KEY = credentials('RIOT_API_KEY')
        sonarAuthToken = credentials('sonar_key');
    }
    stages {
        stage('Build') {
            steps {
                sh 'cd ./Application && docker build ./App -t img-app && docker compose build --build-arg RIOT_API_KEY="$RIOT_API_KEY"'
            }
        }
        stage('Deploy') {
            steps {
                sh 'cd ./Application && docker compose down && docker container prune && docker compose up -d'
            }
        }
    

        stage('SBOM') {
            steps {
                sh 'syft img-app >> sbom.txt'
            }
        }

        stage ('OWASP Dependency-Check Vulnerabilities') {
            steps {
                dependencyCheck additionalArguments: '--format HTML', odcInstallation: 'owaspdpcheck'
            }
        }  

        stage('Snyk Scan') {
            steps {
                script {
                    def snykCommand = """snyk test --all-projects > snyk-output.txt"""
                    def snykScanResult = sh(script: snykCommand, returnStatus: true)

                    def snykOutputCommand = """snyk test --all-projects | tee -a snyk-output.txt"""

                    def snykOutputResult = sh(script: snykOutputCommand, returnStatus: true)

                    if (snykScanResult != 0) {
                        currentBuild.result = 'FAILURE'
                        error("Snyk scan failed")
                    }
                }
            }
        }
        
        stage('GitGuardian Scan') {
            agent {
                any { image 'gitguardian/ggshield:latest' }
            }
            environment {
                GITGUARDIAN_API_KEY = credentials('gitguardian-api-key')
            }
            steps {    
                sh '/var/lib/jenkins/.local/bin/ggshield secret scan ci >> secrets_check.txt'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool name: "sonarscanner", type: 'hudson.plugins.sonar.SonarRunnerInstallation';

                    sh """${scannerHome}/bin/sonar-scanner -Dsonar.login=${sonarAuthToken}""" 
                }
            }
        }

    }
}
